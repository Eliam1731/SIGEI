
UPDATE ejemplo de JSON

{
    "Equipo_id": "1",
    "Subcategoria": "1",
    "Marca": "2",
    "Modelo": "MacBook Pro",
    "N_serie": "ABC123",
    "Fecha_compra": "01-01-2022",
    "Fecha_garantía": "01-01-2023",
    "Importe": "200000",
    "Imagenes":FFD8FFE000104A46494600010100000100010000FFDB008400060606060706070808070A0B0A0B0A0F0E0C0C0E0F1610111011101622151915151915221E241E1C1E241E362A26262A363E3432343E4C44444C5F5A5F7C7CA701060606060706070808070A0B0A0B0A0F0E0C0C0E0F1610111011101622151915151915221E241E1C1E241E362A26262A363E3432343E4C44444C5F5A5F7C7CA7FFC200110804B0064003012200021101031101FFC4003000010101010101010000000000000000000001020403050601010101010100000000000000000000000001020304FFDA000C03010002100310000002F19662D85144B284A08504001400508A16CB4B296CD23529759A6ACB5689BF7F0F65FAA00500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000102004A24A24B2A2C22C2020202024A24A3F372B1A45A2512C28008B0A02050029526A0B65AA51ACE8B654BACDAD594D04DFB78FAAFD5B9D00A0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000020010040415251251258258258258258407E6C635165160512CA251160582800B0514AA8B29529A06ACB65D6745B34529AF5F2F53E9EFCBD4050000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000408012C12CA4B08B08092892892892C12C3F3633A2500012800040A0000A2A84B651652D94D5CE92D96B565356535E9E7E87D1F6E7E8014000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004002004A ,
    "Especificación": "Especificaciones detalladas aquí",
    "Comentarios": "Comentarios aquí",
    "Service_tag": "ServiceTag123",
    "Factura": "255044462D312E370D0A25B5B5B5B50D0A312030206F626A0D0A3C3C2F547970652F436174616C6F672F50616765732032203020522F4C616E6728657329202F53747275637454726565526F6F74203135203020522F4D61726B496E666F3C3C2F4D61726B656420747275653E3E2F4D65746164617461203237203020522F566965776572507265666572656E636573203238203020523E3E0D0A656E646F626A0D0A322030206F626A0D0A3C3C2F547970652F50616765732F436F756E7420312F4B6964735B2033203020525D203E3E0D0A656E646F626A0D0A332030206F626A0D0A3C3C2F547970652F506167652F506172656E742032203020522F5265736F75726365733C3C2F466F6E743C3C2F46312035203020522F4632203132203020523E3E2F4578744753746174653C3C2F47533130203130203020522F47533131203131203020523E3E2F50726F635365745B2F5044462F546578742F496D616765422F496D616765432F496D616765495D203E3E2F4D65646961426F785B2030203020363132203739325D202F436F6E74656E747320342",
    "N_referencia_Compras": "Ref123",
    "MAC_Ethernet": "00:0a:95:9d:68:16",
    "MAC_WIFI": "00:0a:95:9d:68:17"
}

equipment_expense ejemplo JSON

{
    "Equipo_id": 1,
    "Cantidad": ,
    "Piezas": "Disco duro SSD",
    "Fecha": "2022-01-01",
    "Recibo_pdf": "base64 del recibo en pdf"
}

Delete_img ejemplo JSON

{
    "Equipo_id": 1,
    "Imagen_id": 2
}

codigo para modificar la tabla de gastos
    ALTER TABLE `gastos_de_los_equipos`
    MODIFY `Recibo_pdf` MEDIUMBLOB NOT NULL;

.....
{
    "equipo_id": 1,
    "user_id": 2,
    "motivo_baja": "El equipo está obsoleto"


}


modificacion de tablas sql:

ALTER TABLE `resguardos_de_equipos`
MODIFY COLUMN `Fecha_autorizacion` date NOT NULL;

la manera en la que debes mandarme las fechas es de la seguiente 

Asi 2024-03-04 no asi 2024/03/04
Manera correcta: 2024-03-04 
Manera incorrecta: 2020/03/04

modificacion tabla sql para la fecha de garantia:

ALTER TABLE equipos_informaticos MODIFY Fecha_garantia date DEFAULT NULL;


clave de objetos equipos


<?php
include '../config/connection_db.php';

if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    $data = [
        'select_category' => $_POST['select__category'],
        'brandDevices' => $_POST['brandDevices'],
        'modelDevices' => $_POST['modelDevices'],
        'serialNumber' => $_POST['serialNumber'],
        'dateBuy' => $_POST['dateBuy'],
        'dateExpiresWarranty' => $_POST['dateExpiresWarranty'],
        'amountDevices' => $_POST['amountDevices'],
        'addressMacWifi' => $_POST['addressMacWifi'],
        'specificationDevices' => $_POST['specificationDevices'],
        'detailsExtraDevices' => $_POST['detailsExtraDevices'],
        'serviceTag' => $_POST['serviceTag'],
        'referenceCompaq' => $_POST['referenceCompaq'],
        'addressEthernet' => $_POST['addressEthernet'],
        'status' => '1',
        'codigo' => $_POST['codeEquipment'],
    ];

    if ($data['codigo'] === '') {
        $data['codigo'] = null;
    }

    $stmt = $conn->prepare("SELECT Subcategoria_id FROM subcategoria WHERE Nom_subcategoria = :select_category");
    $stmt->bindParam(':select_category', $data['select_category']);
    $stmt->execute();
    $row = $stmt->fetch(PDO::FETCH_ASSOC);
    $data['subcategoryId'] = $row['Subcategoria_id'];

    $fieldsToCheck = [
        'Num_serie' => [
            'field' => 'serialNumber',
            'message' => 'El número de serie ya está en uso. Intenta con otro número de serie.'
        ],
        'Direccion_mac_wifi' => [
            'field' => 'addressMacWifi',
            'message' => 'La dirección MAC WIFI ya está en uso. Intenta con otra dirección MAC WIFI.'
        ],
        'Direccion_mac_ethernet' => [
            'field' => 'addressEthernet',
            'message' => 'La dirección MAC Ethernet ya está en uso. Intenta con otra dirección MAC Ethernet.'
        ],
        'Num_ref_compaq' => [
            'field' => 'referenceCompaq',
            'message' => 'El número de referencia de Compaq ya está en uso. Intenta con otro número de referencia de Compaq.'
        ],
        'Service_tag' => [
            'field' => 'serviceTag',
            'message' => 'El Service tag del equipo ya está en uso. Intenta con otro Service tag.'
        ]
    ];

    foreach ($fieldsToCheck as $dbField => $checkData) {
        if ($data[$checkData['field']] !== null) {
            $stmt = $conn->prepare("SELECT $dbField FROM equipos_informaticos WHERE $dbField = :field");
            $stmt->bindParam(':field', $data[$checkData['field']]);
            $stmt->execute();
            $row = $stmt->fetch(PDO::FETCH_ASSOC);

            if ($row) {
                $response['status'] = 'error';
                $response['message'] = $checkData['message'];
                header('Content-Type: application/json');
                print json_encode($response);
                return;
            }
        }
    }

    //Aqui realice la validacion del Codigo OPCIC espero este bien:(

    $codigoCompleto = 'OPCIC-COM-' . $data['codigo'];
    $stmt = $conn->prepare("SELECT miId FROM equipos_informaticos WHERE miId = :codigo");
    $stmt->bindParam(':codigo', $codigoCompleto);
    $stmt->execute();
    $row = $stmt->fetch(PDO::FETCH_ASSOC);

    if ($row) {
        $response['status'] = 'error';
        $response['message'] = 'El código ' . $codigoCompleto . ' ya está en uso. Intenta con otro código.';
    } else {

        // Si todas las verificaciones son exitosas, entonces insertar los datos
        $conn->beginTransaction();
        $equipment_id = null;

        try {
            $stmt = $conn->prepare("INSERT INTO equipos_informaticos (
                Id_subcategoria,
                Id_marca,
                Modelo,
                Num_serie,
                Especificacion,
                Fecha_compra,
                Fecha_garantia,
                Importe,
                Direccion_mac_wifi,
                Direccion_mac_ethernet,
                Num_ref_compaq,
                Service_tag,
                Comentarios,
                Status_id
                ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)");

            $executeResult = $stmt->execute([
                $data['subcategoryId'],
                $data['brandDevices'],
                $data['modelDevices'],
                $data['serialNumber'],
                $data['specificationDevices'],
                $data['dateBuy'],
                $data['dateExpiresWarranty'],
                $data['amountDevices'],
                $data['addressMacWifi'],
                $data['addressEthernet'],
                $data['referenceCompaq'],
                $data['serviceTag'],
                $data['detailsExtraDevices'],
                $data['status'],
            ]);

            if (!$executeResult) {
                // La consulta falló
                $errorInfo = $stmt->errorInfo();
                throw new Exception('La consulta de inserción falló: ' . var_export($errorInfo, true));
            }

            $equipment_id = $conn->lastInsertId();

            if ($data['codigo'] === null) {
                $data['codigo'] = 'OPCIC-COM-' . str_pad($equipment_id, 5, '0', STR_PAD_LEFT);
            } else {
                $data['codigo'] = 'OPCIC-COM-' . $data['codigo'];
            }

            $stmt = $conn->prepare("UPDATE equipos_informaticos SET miId = ? WHERE Equipo_id = ?");
            $stmt->execute([$data['codigo'], $equipment_id]);

            // Insertar imágenes
            for ($i = 0; $i < count($_FILES['images']['name']); $i++) {
                $imageName = $_FILES['images']['name'][$i];
                $imageType = $_FILES['images']['type'][$i];
                $imageData = file_get_contents($_FILES['images']['tmp_name'][$i]);

                $stmt = $conn->prepare("INSERT INTO imagenes (Nombre, Tipo_mime, Datos_imagen, Equipo_id) VALUES (?, ?, ?, ?)");
                $stmt->execute([$imageName, $imageType, $imageData, $equipment_id]);
            }

            // Insertar facturas
            if (isset($_FILES['invoices'])) {
                for ($i = 0; $i < count($_FILES['invoices']['name']); $i++) {
                    $invoiceContent = file_get_contents($_FILES['invoices']['tmp_name'][$i]);

                    $stmt = $conn->prepare("INSERT INTO facturas (Factura_file, Equipo_id) VALUES (?, ?)");
                    $stmt->execute([$invoiceContent, $equipment_id]);
                }
            }

            $conn->commit();

            $response['status'] = 'success';
            $response['message'] = 'El registro se realizó correctamente.';
            $response['equipment_id'] = $equipment_id;
            $response['formatted_equipment_id'] = $data['codigo'];
        } catch (Exception $e) {
            $conn->rollback();

            $response['status'] = 'error';
            $response['message'] = 'Hubo un error al realizar el registro.' . $e->getMessage();
        }
    }

    header('Content-Type: application/json');
    print json_encode($response);
}
?>